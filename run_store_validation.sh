#!/bin/bash
# Store Validation Pipeline - Post-Deployment Health Checks
# Run after TestFlight/Play Internal deployment to validate mobile readiness

set -e

echo "ğŸš€ SAMIA-TAROT Store Deployment Validation Pipeline"
echo "=================================================="

# Configuration
ENVIRONMENTS=("staging" "production")
REQUIRED_HEALTH_SCORE=85
VALIDATION_PASSED=true

# Function to run validation suite
run_validation_suite() {
    local env=$1
    echo ""
    echo "ğŸ” Validating $env environment..."
    echo "--------------------------------"
    
    # Run synthetic probes
    python3 synthetic_probes.py "$env"
    probe_exit_code=$?
    
    # Run security hardening tests (if local/staging)
    if [ "$env" != "production" ]; then
        echo ""
        echo "ğŸ”’ Running security hardening tests..."
        python3 test_security_hardening.py
        security_exit_code=$?
    else
        security_exit_code=0
    fi
    
    # Run TikTok rejection tests
    echo ""
    echo "ğŸš« Running TikTok rejection validation..."
    python3 test_tiktok_rejection.py
    tiktok_exit_code=$?
    
    # Check overall results
    if [ $probe_exit_code -ne 0 ] || [ $security_exit_code -ne 0 ] || [ $tiktok_exit_code -ne 0 ]; then
        echo "âŒ Validation FAILED for $env"
        VALIDATION_PASSED=false
        return 1
    else
        echo "âœ… Validation PASSED for $env"
        return 0
    fi
}

# Function to validate privacy manifest
validate_privacy_compliance() {
    echo ""
    echo "ğŸ”’ Validating privacy manifest compliance..."
    echo "-------------------------------------------"
    
    python3 validate_privacy_manifest.py
    privacy_exit_code=$?
    
    if [ $privacy_exit_code -ne 0 ]; then
        echo "âŒ Privacy manifest validation FAILED"
        VALIDATION_PASSED=false
        return 1
    else
        echo "âœ… Privacy manifest validation PASSED"
        return 0
    fi
}

# Main validation pipeline
main() {
    echo "ğŸ“‹ Pre-flight checks..."
    
    # Check required files exist
    required_files=(
        "synthetic_probes.py"
        "test_security_hardening.py" 
        "test_tiktok_rejection.py"
        "validate_privacy_manifest.py"
        "ios/PrivacyInfo.xcprivacy"
    )
    
    for file in "${required_files[@]}"; do
        if [ ! -f "$file" ]; then
            echo "âŒ Required file missing: $file"
            exit 1
        fi
    done
    
    echo "âœ… All required files present"
    
    # Run privacy validation (local check)
    validate_privacy_compliance
    
    # Run environment validations
    for env in "${ENVIRONMENTS[@]}"; do
        run_validation_suite "$env"
    done
    
    echo ""
    echo "=================================================="
    
    if [ "$VALIDATION_PASSED" = true ]; then
        echo "âœ… STORE DEPLOYMENT VALIDATION PASSED"
        echo "ğŸ“± Ready for TestFlight Beta â†’ Production promotion"
        echo "ğŸ‰ Safe for public App Store/Play Store release"
        
        # Generate deployment readiness report
        cat > deployment_readiness_report.md << EOF
# ğŸ“± Mobile Store Deployment Readiness Report

**Status**: âœ… **APPROVED FOR PRODUCTION**  
**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
**Validation Pipeline**: PASSED

## âœ… Validation Results

### Security & Compliance
- [x] Security hardening tests passed
- [x] TikTok ingestion fully disabled (410 responses)
- [x] Privacy manifest compliance validated
- [x] Payment webhook HMAC verification working
- [x] Signed URL TTL policies enforced (â‰¤15min default)

### API Health Validation
- [x] Health endpoints responding correctly
- [x] Daily horoscopes public API functional
- [x] Authentication flows properly secured
- [x] Metadata endpoints returning valid data

### Store Readiness
- [x] iOS PrivacyInfo.xcprivacy validated against actual data flows
- [x] Android Data Safety questionnaire alignment confirmed
- [x] Screenshot specifications documented
- [x] Synthetic probes configured for post-deployment monitoring

## ğŸš€ Deployment Approval

**The SAMIA-TAROT mobile application is approved for:**
- TestFlight Beta distribution âœ…
- Google Play Internal Testing âœ…
- Production store submission âœ…

**Next Steps:**
1. Submit to TestFlight for beta review
2. Deploy to Google Play Internal track
3. Monitor synthetic probes post-deployment
4. Proceed with public store release after beta validation

---
*Generated by Store Validation Pipeline - $(date)*
EOF
        
        echo "ğŸ“„ Deployment readiness report generated: deployment_readiness_report.md"
        exit 0
    else
        echo "âŒ STORE DEPLOYMENT VALIDATION FAILED"
        echo "ğŸš¨ Fix validation issues before mobile release"
        echo "ğŸ“‹ Review individual test outputs above for details"
        exit 1
    fi
}

# Run with verbose output
set -x
main "$@"