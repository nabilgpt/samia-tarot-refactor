#!/usr/bin/env node
/**
 * ğŸ” SAMIA TAROT - Quick Database Audit Script
 * Comprehensive check of current database state
 */

const { createClient } = require('@supabase/supabase-js');

// Supabase configuration
const supabaseUrl = 'https://uuseflmielktdcltzwzt.supabase.co';
const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2VmbG1pZWxrdGRjbHR6d3p0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODM0NTExNSwiZXhwIjoyMDYzOTIxMTE1fQ.TNcj0otaeYtl0nDJYn760wSgSuKSYG8s7r-LD04Z9_E';

const supabase = createClient(supabaseUrl, supabaseServiceKey);

class DatabaseAuditor {
  constructor() {
    this.criticalTables = [
      'profiles', 'bookings', 'services', 'notifications',
      'payment_methods', 'wallet_transactions', 'payment_receipts',
      'chat_sessions', 'chat_messages', 'voice_notes',
      'daily_analytics', 'reader_analytics', 'user_activity_logs',
      'ai_learning_data', 'ai_reading_results', 'reader_applications',
      'tarot_decks', 'tarot_spreads', 'call_sessions',
      'call_recordings', 'emergency_call_logs', 'reader_schedule',
      'working_hours_requests', 'system_settings', 'app_config',
      'admin_users', 'emergency_escalations'
    ];
    
    this.productionBlockers = [
      'payment_methods', 'wallet_transactions', 'chat_sessions',
      'daily_analytics', 'emergency_escalations'
    ];
  }

  async runAudit() {
    console.log('ğŸ” SAMIA TAROT - DATABASE AUDIT REPORT');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('Date:', new Date().toISOString());
    console.log('');

    try {
      const results = await this.checkAllTables();
      this.generateReport(results);
    } catch (error) {
      console.error('ğŸ’¥ Audit failed:', error.message);
    }
  }

  async checkAllTables() {
    const results = {
      existing: [],
      missing: [],
      errors: [],
      totalTables: 0,
      completionPercentage: 0
    };

    console.log('ğŸ“‹ CHECKING CRITICAL TABLES:\n');

    for (const table of this.criticalTables) {
      try {
        const { data, error } = await supabase
          .from(table)
          .select('id')
          .limit(1);

        if (error) {
          console.log(`âŒ ${table} - ${error.message}`);
          results.missing.push(table);
        } else {
          console.log(`âœ… ${table} - EXISTS and ACCESSIBLE`);
          results.existing.push(table);
        }
      } catch (e) {
        console.log(`ğŸ’¥ ${table} - CONNECTION ERROR: ${e.message}`);
        results.errors.push({ table, error: e.message });
      }
    }

    results.totalTables = this.criticalTables.length;
    results.completionPercentage = (results.existing.length / results.totalTables * 100).toFixed(1);

    return results;
  }

  generateReport(results) {
    console.log('\nğŸ“Š AUDIT SUMMARY:');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`âœ… Existing Tables: ${results.existing.length}`);
    console.log(`âŒ Missing Tables: ${results.missing.length}`);
    console.log(`ğŸ’¥ Error Tables: ${results.errors.length}`);
    console.log(`ğŸ“ˆ Completion: ${results.completionPercentage}%`);

    if (results.missing.length > 0) {
      console.log('\nğŸš¨ MISSING CRITICAL TABLES:');
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
      results.missing.forEach(table => {
        const isBlocker = this.productionBlockers.includes(table);
        const priority = isBlocker ? 'ğŸ”´ CRITICAL' : 'ğŸŸ¡ HIGH';
        console.log(`${priority} ${table}`);
      });
    }

    if (results.errors.length > 0) {
      console.log('\nğŸ’¥ CONNECTION ERRORS:');
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
      results.errors.forEach(err => {
        console.log(`âŒ ${err.table}: ${err.error}`);
      });
    }

    // Generate recommendations
    console.log('\nğŸ’¡ RECOMMENDATIONS:');
    console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    
    if (results.completionPercentage < 50) {
      console.log('ğŸ”´ CRITICAL: Execute COMPLETE_MISSING_TABLES.sql immediately');
    } else if (results.completionPercentage < 80) {
      console.log('ğŸŸ¡ HIGH: Execute remaining table creation scripts');
    } else if (results.completionPercentage < 95) {
      console.log('ğŸŸ¢ GOOD: Minor table fixes needed');
    } else {
      console.log('ğŸ‰ EXCELLENT: Database is production ready');
    }

    // Check production blockers
    const missingBlockers = results.missing.filter(table => 
      this.productionBlockers.includes(table)
    );

    if (missingBlockers.length > 0) {
      console.log('\nğŸš¨ PRODUCTION BLOCKERS DETECTED:');
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
      missingBlockers.forEach(table => {
        console.log(`ğŸ”´ ${table} - Blocks core functionality`);
      });
      console.log('\nâš¡ IMMEDIATE ACTION REQUIRED:');
      console.log('Execute COMPLETE_MISSING_TABLES.sql to fix all issues');
    }
  }
}

// Run the audit
const auditor = new DatabaseAuditor();
auditor.runAudit().catch(console.error); 